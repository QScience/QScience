<?php

ini_set('xdebug.max_nesting_level', 600);

/**
 * Implements hook_insert
 */
function qscience_node_insert($node) {
  if ($node->type === 'author') {
    //qscience_paper_uploaded();
  }
  else {
    //watchdog('qscience', 'NOT author node inserting...');
  }
}

/**
 * Implements file_insert
 */
function qscience_file_insert($file) {
  if ($_POST['form_id'] == 'paper_node_form') {
    qscience_paper_uploaded($file);
  }
}

function qscience_paper_uploaded($file) {
  foreach (module_implements('paper_uploaded') as $module) {
    if ($module === 'qscience') continue;
    module_invoke($module, 'paper_uploaded', $file);
  }
}

function qscience_form_paper_node_form_alter(&$form, &$form_state, $form_id) {
  drupal_add_js(drupal_get_path('module', 'qscience') . '/js/qscience.js', 'file');
  
  //$form['']

  $form['authors']['author_1'] = array(
    '#type' => 'textfield',
    '#title' => t('Author'),
    '#weight' => 3,
  );

  $form['authors']['author_adder'] = array(
    '#type' => 'button',
    '#value' => t('Add author'),
    '#weight' => 4,
    '#attributes' => array(
      'onclick' => 'return hw();',
    ),
  );

  $form['#submit'][] = 'qscience_add_author_node_by_hand';
}

function qscience_add_author_node_by_hand($form, &$form_state) {
  global $user;

  $i = 1;
  while (isset($_POST['author_'.$i])) {
    $name = trim($_POST['author_'.$i]);
    if (strlen($name) == 0) {
      $i++;
      continue;
    }
    $name = explode(" ", $name);
    $fname = isset($name[0]) ? $name[0] : 'unknown';
    $lname = isset($name[1]) ? $name[1] : 'unknown';

    $node = new stdClass();
    $node->type = 'author';
    $node->title = $fname . ' ' .$lname;
    $node->uid = $user->uid;
    $path = 'content/pcn_' . date('YmdHis');
    //$node->path = array('alias' => $path);
    node_object_prepare($node);
       
    $node->language = LANGUAGE_NONE;
    $node->first_name[$node->language][0]['value'] = $fname;
    $node->last_name[$node->language][0]['value'] = $lname;
    
    $node = node_submit($node);
    node_save($node);
    $i++;
  }
}

